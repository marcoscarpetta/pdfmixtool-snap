name: pdfmixtool
confinement: strict
grade: stable
base: core18
adopt-info: pdfmixtool

architectures:
  - build-on: amd64
  #- build-on: arm64
  #- build-on: armhf
  #- build-on: i386 # Not supported by core20
  #- build-on: ppc64el
  #- build-on: s390x

apps:
  pdfmixtool:
    command: usr/bin/pdfmixtool
    common-id: eu.scarpetta.PDFMixTool
    desktop: usr/share/applications/eu.scarpetta.PDFMixTool.desktop
    extensions:
      - kde-neon
    plugs:
      - opengl

plugs:
  kde-frameworks-5-plug:
    content: kde-frameworks-5-qt-5-14-core18-all
    interface: content
    default-provider: kde-frameworks-5-qt-5-14-core18
    target: kf5

parts:
  pdfmixtool:
    after:
      - libqpdf
    source: https://gitlab.com/scarpetta/pdfmixtool/-/archive/f188463dc5e05e5587bc7c8f736794135a4c273c/pdfmixtool-f188463dc5e05e5587bc7c8f736794135a4c273c.tar.gz
    override-pull: |
      snapcraftctl pull
      # Point icon to the correct location
      sed -i.bak -i -e 's|Icon=eu.scarpetta.PDFMixTool|Icon=/usr/share/icons/hicolor/scalable/apps/eu.scarpetta.PDFMixTool.svg|g' resources/eu.scarpetta.PDFMixTool.desktop
    plugin: cmake
#    cmake-parameters:
    configflags:
      - -DCMAKE_INSTALL_PREFIX=/usr
      - -DCMAKE_BUILD_TYPE=Release
    parse-info:
      - usr/share/metainfo/eu.scarpetta.PDFMixTool.appdata.xml
    build-snaps:
      - kde-frameworks-5-qt-5-14-core18-sdk
    build-packages:
      - libglvnd-dev

  libqpdf:
    plugin: make
    override-build: |
      ./configure --prefix=/usr --disable-static
      make
      make DESTDIR=$SNAPCRAFT_PART_INSTALL install
    source: https://github.com/qpdf/qpdf/releases/download/release-qpdf-10.3.1/qpdf-10.3.1.tar.gz
    build-packages:
      - build-essential
      - pkg-config
      - libjpeg8-dev
      - zlib1g-dev
    stage-packages:
      - libjpeg8
      - zlib1g
